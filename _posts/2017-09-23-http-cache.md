---
layout: post
title: "HTTP缓存机制介绍"
date: 2017-09-22 16:23:32
categories: http
tags: tag1 tag2
---

这是前端时间做的一次分享, 起因是我们的网站在更新的时候若js等有变动, 需要用户强刷才能获取最新内容, 借这个机会了解了HTTP缓存的机制. 本文的主要内容基本上取自RFC-7234, 翻译整理加自己的理解, 加上一些其他资料和图片.

## 提出问题
- 为什么要清除缓存/强刷?
 - 简单说原因就是因为浏览器缓存了旧版本的文件, 在打开页面时直接使用缓存, 没有向服务器发起对 新部署上的文件的请求, 所以需要强刷.
- 为什么要缓存? 
 - HTTP缓存的设计 一是为了节省带宽流量资源. 二是为了减少浏览器打开页面的响应时间.
- 如何做的缓存? 后文解答
- 强刷是什么? 后文解答

## 划清范围
本文中"缓存"一词, 特指在HTTP协议相关的, 出现在浏览器, 中间代理服务器上的, 对于HTTP响应消息的缓存, 不涉及其他的如网关层,CDN,后端负载均衡等处的缓存.

HTTP缓存, 从类型上分两种shared cache / private cache, 前者可被中间代理和浏览器缓存,后者只能被浏览器缓存.

![缓存类型](/resources/HTTPCachtType.png)

这两种缓存除使用范围限制, 其他没什么不同, 下文基本不做区分.

## 缓存定义
在指南中对HTTP Cache做了如下定义:

- a local store of response messages
- the subsystem that controls storage, retrieval, and deletion of messages in it.
## 存的是什么
HTTP缓存是一种类似KV的storage.

基本的Key是由请求方法和目标URI构成的. 由于目前主要缓存GET请求的响应, 所以在chrome等浏览器中, 缓存的key只由uri构成.
value则是对应的key, 在之前发起请求时得到的响应消息.

(value可能是多条, 这就涉及二级Key (secondary key: 当content negotiation时, 使用Vary特定header作为二级key,后文详细介绍))

在chrome浏览器可以通过 chrome://cache/ 页面来查看当前的所有缓存

![chrome缓存页面](/resources/chrome-cache.png)

点进其中每一条, 就可以看到对应的被缓存的HTTP响应消息.
## 何时存(缓存先决条件)
因为RFC只是一份指南, 而具体的细节取决于其实现, 也就是说浏览器有很多自己控制的空间. 对于何时缓存, RFC 7234中使用这样的词汇: "MUST NOT store a response to any request, unless:", 就是说除非以下这些条件都满足, 否则不能缓存, 但是满足了这些条件, 浏览器到底要不要缓存却不一定. 我们来看一下这些条件:

- 特定的请求方法(GET,HEAD, POST(post只有显式的设置才会缓存))     且
- public cache时, 不能是Authentication的    且
- private cache时, 不能被中间代理缓存    且
- 响应没有no-store指令    且
- 特定的Headers符合条件:
 - Expires header      或
 - Cache Control header 中
 - 包含max-age/s-maxage指令     或
 - 包含public指令    或
 - `扩展指令`表示允许缓存    或
 - 特定的返回code( 200, 203, 204, 206, 300, 301, 404, 405, 410, 414, and 501) 

前几条要求都是比较好理解的, 也比较容易满足. 而第5条下面的各个"或"的要求中, 只要返回码是200等, 就能缓存. 哇, 这就意味着, 大多数请求, 按规定都是可以缓存的, 这刷新了我以前"只有CSS/JS/图片才会缓存"的认知.

## 何时用
响应被缓存后, 什么时候,什么条件下才能被采用呢? 当一条新的请求要发出前, 浏览器要判断这些条件(When presented with a request, a cache MUST NOT reuse a stored response, unless):

- uri  match stored response     且
- 请求方法运行    且
- 当前请求的Header满足 对应缓存响应的Vary的要求    且
- 请求没有no-cache指令     且
- 对应的被缓存的响应是:
 - fresh   或
 - allowed to be served stale      或
 - successfully validated

## 名词解释
- `Fresh` : 新鲜的 A stored response is considered “fresh"  if the response can be reused without “validation”.
- `Stale` : 不新鲜的
- `validation` : 验证 
- `age` : 年龄 A response’s age is the time that has passed since it was generated by, or successfully validated with, the origin server.
- `cache eviction` : 缓存逐出 Caches have finite storage so items are periodically removed from storage
- `selecting header` : 是指响应的Vary头的值里指定的header

